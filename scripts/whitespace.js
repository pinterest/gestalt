#!/usr/bin/env node
// eslint-disable-next-line eslint-comments/disable-enable-pair
/* eslint-disable gestalt/only-valid-tokens */

/* eslint-env node */
/* eslint no-console:0 */

const PRELUDE = `/*
This file was generated by running

  $ node ./scripts/whitespace.js > packages/gestalt/src/boxWhitespace.css

*/`;

const SCALE_LENGTH = 16;
const SCALE = [...new Array(SCALE_LENGTH).fill().map((_, i) => i + 1), 0.25, 0.5, 1.5].sort();

// --

const space = (n) => {
  if (n === 0) return 'var(--space-0)';
  if (n === 0.25) return '1px';
  if (n === 0.5) return '2px';
  if (n === 1.5) return '6px';
  if (n === -0.25) return '-1px';
  if (n === -0.5) return '-2px';
  if (n === -1.5) return '-6px';
  return `var(--space-${n < 0 ? `negative${n}` : `${n}`}00)`;
};

const block = (str) =>
  [
    '{',
    str
      .split('\n')
      .map((line) => (line.length === 0 ? '' : `  ${line}`))
      .join('\n'),
    '}',
  ].join('\n');

const Declaration = ({ property, value }) => `${property}: ${value};`;

const Ruleset = ({ selector, declarations }) =>
  `${selector} ${block(
    Object.keys(declarations)
      .map((property) => Declaration({ property, value: declarations[property] }))
      .join('\n'),
  )}`;

const AtRule = ({ query, rulesets }) =>
  `@media (${query}) ${block(rulesets.map(Ruleset).join('\n\n'))}`;

const Statement = (obj) => {
  switch (obj.kind) {
    case 'ruleset':
      return Ruleset(obj);
    case 'atrule':
      return AtRule({ query: obj.query, rulesets: obj.rulesets });
    default:
      throw new Error(`Unexpected statement kind ${obj.kind}`);
  }
};

const Stylesheet = (statements) => [PRELUDE].concat(statements.map(Statement)).join('\n\n');

// --

const ruleset = (selector, declarations) => ({
  kind: 'ruleset',
  selector,
  declarations,
});

const atrule = (query, rulesets) => ({
  kind: 'atrule',
  query,
  rulesets,
});

const capitalize = (str) => `${str.substring(0, 1).toUpperCase()}${str.substring(1, str.length)}`;
const classname = (namespace, className) =>
  namespace ? `.${namespace}${capitalize(className)}` : `.${className}`;

const rules = (i, prefix) => [
  ruleset(`html:not([dir="rtl"]) ${classname(prefix, `marginStart${i * 100}`)}`, {
    'margin-left': space(i),
  }),
  ruleset(`html:not([dir="rtl"]) ${classname(prefix, `marginEnd${i * 100}`)}`, {
    'margin-right': space(i),
  }),
  ruleset(`html[dir="rtl"] ${classname(prefix, `marginStart${i * 100}`)}`, {
    'margin-right': space(i),
  }),
  ruleset(`html[dir="rtl"] ${classname(prefix, `marginEnd${i * 100}`)}`, {
    'margin-left': space(i),
  }),
  ...(i !== 0
    ? [
        ruleset(`html:not([dir="rtl"]) ${classname(prefix, `marginStartN${i * 100}`)}`, {
          'margin-left': space(-i),
        }),
        ruleset(`html:not([dir="rtl"]) ${classname(prefix, `marginEndN${i * 100}`)}`, {
          'margin-right': space(-i),
        }),
        ruleset(`html[dir="rtl"] ${classname(prefix, `marginStartN${i * 100}`)}`, {
          'margin-right': space(-i),
        }),
        ruleset(`html[dir="rtl"] ${classname(prefix, `marginEndN${i * 100}`)}`, {
          'margin-left': space(-i),
        }),
      ]
    : []),
  ruleset(classname(prefix, `marginTop${i * 100}`), {
    'margin-top': space(i),
  }),
  ruleset(classname(prefix, `marginBottom${i * 100}`), {
    'margin-bottom': space(i),
  }),
  ...(i !== 0
    ? [
        ruleset(classname(prefix, `marginTopN${i * 100}`), {
          'margin-top': space(-i),
        }),
        ruleset(classname(prefix, `marginBottomN${i * 100}`), {
          'margin-bottom': space(-i),
        }),
      ]
    : []),
  ruleset(classname(prefix, `paddingY${i * 100}`), {
    'padding-bottom': space(i),
    'padding-top': space(i),
  }),

  ruleset(classname(prefix, `paddingX${i * 100}`), {
    'padding-left': space(i),
    'padding-right': space(i),
  }),
];

const autoRules = (prefix) => [
  ruleset(`html:not([dir="rtl"]) ${classname(prefix, `marginStartAuto`)}`, {
    'margin-left': 'auto',
  }),
  ruleset(`html:not([dir="rtl"]) ${classname(prefix, `marginEndAuto`)}`, {
    'margin-right': 'auto',
  }),
  ruleset(`html[dir="rtl"] ${classname(prefix, `marginStartAuto`)}`, {
    'margin-right': 'auto',
  }),
  ruleset(`html[dir="rtl"] ${classname(prefix, `marginEndAuto`)}`, {
    'margin-left': 'auto',
  }),
  ruleset(classname(prefix, `marginTopAuto`), {
    'margin-top': 'auto',
  }),
  ruleset(classname(prefix, `marginBottomAuto`), {
    'margin-bottom': 'auto',
  }),
];

console.log(
  Stylesheet([
    // Add margin/padding for auto + spacing -16 through 16 (keep non-@media first,
    // followed by sequential sm/md/lg @media rules to allow proper @media overriding)
    ...autoRules(),
    ...[0, ...SCALE].reduce((arr, i) => arr.concat(rules(i)), []),

    atrule('--g-sm', autoRules('sm')),
    atrule(
      '--g-sm',
      [0, ...SCALE].reduce((arr, i) => arr.concat(rules(i, 'sm')), []),
    ),

    atrule('--g-md', autoRules('md')),
    atrule(
      '--g-md',
      [0, ...SCALE].reduce((arr, i) => arr.concat(rules(i, 'md')), []),
    ),

    atrule('--g-lg', autoRules('lg')),
    atrule(
      '--g-lg',
      [0, ...SCALE].reduce((arr, i) => arr.concat(rules(i, 'lg')), []),
    ),

    atrule('--g-xl', autoRules('xl')),
    atrule(
      '--g-xl',
      [0, ...SCALE].reduce((arr, i) => arr.concat(rules(i, 'xl')), []),
    ),

    atrule('--g-xxl', autoRules('xxl')),
    atrule(
      '--g-xxl',
      [0, ...SCALE].reduce((arr, i) => arr.concat(rules(i, 'xxl')), []),
    ),

    atrule('--g-xxxl', autoRules('xxxl')),
    atrule(
      '--g-xxxl',
      [0, ...SCALE].reduce((arr, i) => arr.concat(rules(i, 'xxxl')), []),
    ),
  ]),
);
