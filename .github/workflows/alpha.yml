name: Prerelease

on:
  pull_request:
    types:
      - labeled
  issue_comment:
    types: [created]

jobs:
  release-alpha:
    name: Alpha Release Gestalt
    runs-on: ubuntu-latest
    if: |
      contains(github.event.head_commit.message, 'Version bump:') == false && github.repository == 'pinterest/gestalt' && github.event.label.name == 'prerelease' || 
      contains(github.event.head_commit.message, 'Version bump:') == false && github.repository == 'pinterest/gestalt' && github.event.issue.pull_request && contains(github.event.comment.body, '/alpha')
    steps:
      - uses: octokit/graphql-action@v2.0.0
        id: query_labels
        with:
          query: |
            query labels($owner:String!, $name:String!, $oid:GitObjectID!) {
              repository(owner: $owner, name: $name) {
                object(oid: $oid) {
                  ... on Commit {
                    message
                    associatedPullRequests(first: 1) {
                      edges {
                        node {
                          title
                          labels(first: 5) {
                            edges {
                              node {
                                name
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          owner: ${{ github.event.repository.owner.name }}
          name: ${{ github.event.repository.name }}
          oid: ${{ github.event.head_commit.id }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract labels
        id: extract_labels
        env:
          JSON_DATA: ${{ steps.query_labels.outputs.data }}
        run: |
          LABELS=$(echo "${JSON_DATA}" | jq '.repository.object.associatedPullRequests.edges[0].node.labels.edges[].node.name' | tr '\n' ', ')
          echo "::set-output name=labels::${LABELS}"
      - name: Checkout the repo
        uses: actions/checkout@v2
        with:
          persist-credentials: false
          ref: ${{ github.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 16
      - name: Setup npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: echo "//registry.npmjs.org/:_authToken=$NODE_AUTH_TOKEN" >> ~/.npmrc
      - name: Install dependencies
        run: yarn install
      - name: Setup GitHub access tokens
        env:
          RYAN_GITHUB_PERSONAL_TOKEN: ${{ secrets.RYAN_GITHUB_PERSONAL_TOKEN }}
        run: |
          echo "machine github.com" >> ~/.netrc
          echo "login dangerismycat" >> ~/.netrc
          echo "password $RYAN_GITHUB_PERSONAL_TOKEN" >> ~/.netrc
      - name: Release Steps
        id: pre_release_step
        run: ./scripts/releaseSteps.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LABELS: ${{ steps.extract_labels.outputs.labels }}
      - name: Get Github Workflow Verson
        run: echo ${{ steps.release.outputs.VERSION }}
