name: Prerelease

on:
  pull_request:
    types:
      - labeled
  issue_comment:
    types: [created]

jobs:
  release-alpha:
    name: Alpha Release Gestalt
    runs-on: ubuntu-latest
    if: |
      contains(github.event.head_commit.message, 'Version bump:') == false && github.repository == 'pinterest/gestalt' && github.event.label.name == 'prerelease' || 
      contains(github.event.head_commit.message, 'Version bump:') == false && github.repository == 'pinterest/gestalt' && github.event.issue.pull_request && contains(github.event.comment.body, '/alpha')
    steps:
      - name: Print Values
        id: extract_values
        run: |
          echo "commit=" ${{github.event.head_commit.message}}
      - name: Extract labels
        id: extract_labels
        run: |
          echo "::set-output name=labels::["prerelease release"]"
      - name: Checkout the repo
        uses: actions/checkout@v2
        with:
          persist-credentials: false
          ref: ${{ github.ref }}
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 16
      - name: Setup npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: echo "//registry.npmjs.org/:_authToken=$NODE_AUTH_TOKEN" >> ~/.npmrc
      - name: Install dependencies
        run: yarn install
      - name: Setup GitHub access tokens
        env:
          RYAN_GITHUB_PERSONAL_TOKEN: ${{ secrets.RYAN_GITHUB_PERSONAL_TOKEN }}
        run: |
          echo "machine github.com" >> ~/.netrc
          echo "login dangerismycat" >> ~/.netrc
          echo "password $RYAN_GITHUB_PERSONAL_TOKEN" >> ~/.netrc
      - name: Release Steps
        id: pre_release_step
        run: ./scripts/releaseSteps.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LABELS: ${{ steps.extract_labels.outputs.labels }}
      - name: Get Github Workflow Verson
        run: echo ${{ steps.release.outputs.VERSION }}
